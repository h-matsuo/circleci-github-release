version: 2.1

description: |
  Create / delete GitHub's Releases. https://github.com/h-matsuo/circleci-orb-github-release

executors:
  default:
    parameters:
      tag:
        description: Pick a specific circleci/golang image variant
        type: string
        default: "latest"
    docker:
      - image: circleci/golang:<< parameters.tag >>

common-parameters: &common-parameters
  github-token-variable:
    description: Environment variable containing your GitHub personal access token
    type: string
    default: $GITHUB_TOKEN
  user:
    description: GitHub repository user or organization
    type: string
    default: $CIRCLE_PROJECT_USERNAME
  repository:
    description: GitHub repository
    type: string
    default: $CIRCLE_PROJECT_REPONAME
  tag:
    description: Git tag to create the release from
    type: string

commands:

  delete:
    description: Delete an existing release
    parameters:
      <<: *common-parameters
    steps:
      - internal__go-get
      - run:
          name: "[github-release/delete] Delete the specified release"
          command: |
            github-release delete \
              --security-token << parameters.github-token-variable >> \
              --user << parameters.user >> \
              --repo << parameters.repository >> \
              --tag << parameters.tag >>

  create:
    description: Create a new release
    parameters:
      <<: *common-parameters
      target:
        description: Git commitish (commit SHA or branch name) to create the release of
        type: string
        default: $CIRCLE_SHA1
      title:
        description: Name of the release
        type: string
      description:
        description: Description of the release
        type: string
      path:
        description: File path to upload (if directory, all files in the directory will be uploaded)
        type: string
        default: ""
      draft:
        description: Set true if the release is a draft
        type: boolean
        default: false
      pre-release:
        description: Set true if the release is a pre-release
        type: boolean
        default: false
    steps:
      - internal__go-get
      - when:
          condition: << parameters.path >>
          steps:
            - run:
                name: "[github-release/create] Publish a new release with artifacts"
                command: |
                  ghr \
                    --token << parameters.github-token-variable >> \
                    --username << parameters.user >> \
                    --repository << parameters.repository >> \
                    --commitish << parameters.target >> \
                    --name "<< parameters.title >>" \
                    --body "<< parameters.description >>" \
                    <<# parameters.draft >> --draft <</ parameters.draft >> \
                    <<# parameters.pre-release >> --prerelease <</ parameters.pre-release >> \
                      << parameters.tag >> << parameters.path >>
      - unless:
          condition: << parameters.path >>
          steps:
            - run:
                name: "[github-release/create] Publish a new release without artifacts"
                command: |
                  github-release release \
                    --security-token << parameters.github-token-variable >> \
                    --user << parameters.user >> \
                    --repo << parameters.repository >> \
                    --tag << parameters.tag >> \
                    --name "<< parameters.title >>" \
                    --description "<< parameters.description >>" \
                    --target << parameters.target >> \
                    <<# parameters.draft >> --draft <</ parameters.draft >> \
                    <<# parameters.pre-release >> --pre-release <</ parameters.pre-release >>


  internal__go-get:
    description: "(For INTERNAL use) Get tools to manage GitHub's releases"
    steps:
      - run:
          name: "[github-release] Get tools to manage releases"
          command: go get github.com/aktau/github-release github.com/tcnksm/ghr
